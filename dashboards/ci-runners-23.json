{"meta":{"type":"db","canSave":true,"canEdit":true,"canAdmin":false,"canStar":true,"slug":"ci-runners-23","url":"/d/VoHXPmjMk/ci-runners-23","expires":"0001-01-01T00:00:00Z","created":"2021-05-06T04:22:17Z","updated":"2021-05-06T04:25:40Z","updatedBy":"ops-contact@gitlab.com","createdBy":"ops-contact@gitlab.com","version":4,"hasAcl":false,"isFolder":false,"folderId":980,"folderTitle":"Playground - FOR TESTING PURPOSES ONLY","folderUrl":"/dashboards/f/playground-FOR-TESTING-ONLY/playground-for-testing-purposes-only","provisioned":false,"provisionedExternalId":""},"dashboard":{"annotations":{"list":[{"builtIn":1,"datasource":"-- Grafana --","enable":false,"hide":false,"iconColor":"#96D98D","name":"deploy","showIn":0,"tags":["deploy","$environment"],"type":"tags"},{"builtIn":1,"datasource":"-- Grafana --","enable":false,"hide":false,"iconColor":"#FFEE52","name":"canary-deploy","showIn":0,"tags":["deploy","${environment}-cny"],"type":"tags"},{"builtIn":1,"datasource":"-- Grafana --","enable":false,"hide":false,"iconColor":"#CA95E5","name":"feature-flags","showIn":0,"tags":["feature-flag","${environment}"],"type":"tags"}]},"description":"Uploaded by https://gitlab.com/gitlab-com/runbooks/-/jobs/1239985110 at Thu May  6 03:43:56 UTC 2021","editable":true,"gnetId":null,"graphTooltip":1,"id":null,"iteration":1620275084777,"links":[{"asDropdown":true,"icon":"dashboard","includeVars":true,"keepTime":true,"tags":"type:ci-runners","targetBlank":false,"title":"ci-runners Detail","type":"dashboards","url":""},{"asDropdown":true,"icon":"dashboard","includeVars":true,"keepTime":true,"tags":"ci-runners:incident-support","targetBlank":false,"title":"ci-runners Incident Dashboards","type":"dashboards","url":""}],"panels":[{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":"$PROMETHEUS_DS","decimals":2,"description":"Apdex is a measure of requests that complete within a tolerable period of time for the service. Higher is better.","fieldConfig":{"defaults":{"custom":{},"links":[{"targetBlank":true,"title":"ci-runners Service Apdex SLO Analysis","url":"/d/alerts-service_slo_apdex?${__url_time_range}\u0026${__all_variables}\u0026var-type=ci-runners\u0026var-stage=$stage"}]},"overrides":[]},"fill":0,"fillGradient":0,"gridPos":{"h":6,"w":6,"x":0,"y":0},"hiddenSeries":false,"id":3,"legend":{"alignAsTable":true,"avg":true,"current":true,"hideEmpty":true,"max":true,"min":true,"rightSide":false,"show":true,"total":false,"values":true},"lines":true,"linewidth":2,"nullPointMode":"null","options":{"alertThreshold":true},"percentage":false,"pluginVersion":"7.2.0","pointradius":5,"points":false,"renderer":"flot","seriesOverrides":[{"alias":"6h Degradation SLO (5% of monthly error budget)","color":"#FF4500","dashLength":4,"dashes":true,"legend":true,"lines":true,"linewidth":2,"nullPointMode":"connected","spaceLength":10,"zindex":-2},{"alias":"1h Outage SLO (2% of monthly error budget)","color":"#F2495C","dashLength":4,"dashes":true,"legend":true,"lines":true,"linewidth":4,"nullPointMode":"connected","spaceLength":4,"zindex":-2},{"alias":"SLO","color":"#FF4500","dashLength":4,"dashes":true,"legend":true,"lines":true,"linewidth":4,"nullPointMode":"connected","spaceLength":4,"zindex":-2},{"alias":"ci-runners apdex","color":"#E7D551","zindex":3},{"alias":"ci-runners apdex avg","color":"#5794F2","dashLength":1,"fillBelowTo":"ci-runners apdex","linewidth":1,"spaceLength":1,"zindex":-3},{"alias":"last week","color":"#dddddd80","dashLength":4,"dashes":true,"fill":0,"legend":true,"lines":true,"linewidth":1,"nullPointMode":"connected","spaceLength":2,"zindex":-3}],"spaceLength":10,"stableId":"service-ci-runners-apdex","stack":false,"steppedLine":false,"targets":[{"expr":"min_over_time(gitlab_service_apdex:ratio_5m{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"runners\",type=\"ci-runners\"}[$__interval])\n","format":"time_series","interval":"1m","intervalFactor":3,"legendFormat":"ci-runners apdex","refId":"A"},{"expr":"(1 - 6 * (1 - avg(slo:min:events:gitlab_service_apdex:ratio{monitor=\"global\",type=\"ci-runners\"})))\n","format":"time_series","interval":"5m","intervalFactor":3,"legendFormat":"6h Degradation SLO (5% of monthly error budget)","refId":"B"},{"expr":"(1 - 14.4 * (1 - avg(slo:min:events:gitlab_service_apdex:ratio{monitor=\"global\",type=\"ci-runners\"})))\n","format":"time_series","interval":"5m","intervalFactor":3,"legendFormat":"1h Outage SLO (2% of monthly error budget)","refId":"C"},{"expr":"avg_over_time(gitlab_service_apdex:ratio_5m{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"runners\",type=\"ci-runners\"}[$__interval])\n","format":"time_series","interval":"1m","intervalFactor":3,"legendFormat":"ci-runners apdex avg","refId":"D"},{"expr":"clamp_min(\n  gitlab_service_apdex:ratio_5m{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"runners\",type=\"ci-runners\"} offset 1w\n,\n  scalar(min((1 - 14.4 * (1 - avg(slo:min:events:gitlab_service_apdex:ratio{monitor=\"global\",type=\"ci-runners\"})))\n))\n)\n","format":"time_series","interval":"1m","intervalFactor":3,"legendFormat":"last week","refId":"E"}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"ci-runners Service Apdex","tooltip":{"shared":true,"sort":1,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"percentunit","label":"Apdex %","logBase":1,"max":1,"show":true},{"format":"short","logBase":1,"max":1,"min":0,"show":false}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":"$PROMETHEUS_DS","decimals":2,"description":"Error rates are a measure of unhandled service exceptions per second. Client errors are excluded when possible. Lower is better","fieldConfig":{"defaults":{"custom":{},"links":[{"targetBlank":true,"title":"ci-runners Service Error-Rate SLO Analysis","url":"/d/alerts-service_slo_error?${__url_time_range}\u0026${__all_variables}\u0026var-type=ci-runners\u0026var-stage=$stage"}]},"overrides":[]},"fill":0,"fillGradient":0,"gridPos":{"h":6,"w":6,"x":6,"y":0},"hiddenSeries":false,"id":5,"legend":{"alignAsTable":true,"avg":true,"current":true,"hideEmpty":true,"max":true,"min":true,"rightSide":false,"show":true,"total":false,"values":true},"lines":true,"linewidth":2,"nullPointMode":"null","options":{"alertThreshold":true},"percentage":false,"pluginVersion":"7.2.0","pointradius":5,"points":false,"renderer":"flot","seriesOverrides":[{"alias":"6h Degradation SLO (5% of monthly error budget)","color":"#FF4500","dashLength":4,"dashes":true,"legend":true,"lines":true,"linewidth":2,"nullPointMode":"connected","spaceLength":10,"zindex":-2},{"alias":"1h Outage SLO (2% of monthly error budget)","color":"#F2495C","dashLength":4,"dashes":true,"legend":true,"lines":true,"linewidth":4,"nullPointMode":"connected","spaceLength":4,"zindex":-2},{"alias":"ci-runners error ratio","color":"#E7D551","fillBelowTo":"ci-runners error ratio avg","zindex":3},{"alias":"ci-runners error ratio avg","color":"#5794F2","dashLength":1,"fillGradient":10,"linewidth":1,"spaceLength":1,"zindex":-3},{"alias":"last week","color":"#dddddd80","dashLength":4,"dashes":true,"fill":0,"legend":true,"lines":true,"linewidth":1,"nullPointMode":"connected","spaceLength":2,"zindex":-3}],"spaceLength":10,"stableId":"service-ci-runners-error-rate","stack":false,"steppedLine":false,"targets":[{"expr":"clamp_max(\n  max_over_time(gitlab_service_errors:ratio_5m{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"runners\",type=\"ci-runners\"}[$__interval])\n,\n  1\n)\n","format":"time_series","interval":"1m","intervalFactor":3,"legendFormat":"ci-runners error ratio","refId":"A"},{"expr":"(6 * avg(slo:max:events:gitlab_service_errors:ratio{monitor=\"global\",type=\"ci-runners\"}))\n","format":"time_series","interval":"5m","intervalFactor":3,"legendFormat":"6h Degradation SLO (5% of monthly error budget)","refId":"B"},{"expr":"(14.4 * avg(slo:max:events:gitlab_service_errors:ratio{monitor=\"global\",type=\"ci-runners\"}))\n","format":"time_series","interval":"5m","intervalFactor":3,"legendFormat":"1h Outage SLO (2% of monthly error budget)","refId":"C"},{"expr":"clamp_max(\n  avg_over_time(gitlab_service_errors:ratio_5m{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"runners\",type=\"ci-runners\"}[$__interval])\n,\n  1\n)\n","format":"time_series","interval":"1m","intervalFactor":3,"legendFormat":"ci-runners error ratio avg","refId":"D"},{"expr":"clamp_max(\n  gitlab_service_errors:ratio_5m{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"runners\",type=\"ci-runners\"} offset 1w\n,\n  scalar(max((14.4 * avg(slo:max:events:gitlab_service_errors:ratio{monitor=\"global\",type=\"ci-runners\"}))\n))\n)\n","format":"time_series","interval":"1m","intervalFactor":3,"legendFormat":"last week","refId":"E"}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"ci-runners Service Error Ratio","tooltip":{"shared":true,"sort":2,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"percentunit","label":"Error %","logBase":1,"min":0,"show":true},{"format":"short","logBase":1,"max":1,"min":0,"show":false}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":"$PROMETHEUS_DS","decimals":2,"description":"The operation rate is the sum total of all requests being handle for all components within this service. Note that a single user request can lead to requests to multiple components. Higher is busier.","fieldConfig":{"defaults":{"custom":{}},"overrides":[]},"fill":0,"fillGradient":0,"gridPos":{"h":7,"w":6,"x":12,"y":0},"hiddenSeries":false,"id":7,"legend":{"alignAsTable":true,"avg":true,"current":true,"hideEmpty":true,"max":true,"min":true,"rightSide":false,"show":true,"total":false,"values":true},"lines":true,"linewidth":2,"nullPointMode":"null","options":{"alertThreshold":true},"percentage":false,"pluginVersion":"7.2.0","pointradius":5,"points":false,"renderer":"flot","seriesOverrides":[{"alias":"ci-runners RPS","color":"#E7D551","zindex":3},{"alias":"last week","color":"#dddddd80","dashLength":4,"dashes":true,"fill":0,"legend":true,"lines":true,"linewidth":1,"nullPointMode":"connected","spaceLength":2,"zindex":-3},{"alias":"upper normal","color":"#73BF69","dashLength":8,"dashes":true,"fillBelowTo":"lower normal","legend":false,"lines":false,"linewidth":1,"nullPointMode":"connected","spaceLength":8,"zindex":-3},{"alias":"lower normal","color":"#73BF69","dashLength":8,"dashes":true,"legend":false,"lines":false,"linewidth":1,"nullPointMode":"connected","spaceLength":8,"zindex":-3}],"spaceLength":10,"stableId":"service-ci-runners-ops-rate","stack":false,"steppedLine":false,"targets":[{"expr":"avg_over_time(gitlab_service_ops:rate_5m{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"runners\",type=\"ci-runners\"}[$__interval])\n","format":"time_series","interval":"1m","intervalFactor":3,"legendFormat":"ci-runners RPS","refId":"A"},{"expr":"gitlab_service_ops:rate_5m{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"runners\",type=\"ci-runners\"} offset 1w\n","format":"time_series","interval":"1m","intervalFactor":3,"legendFormat":"last week","refId":"B"},{"expr":"clamp_min(\n  avg by (type) (\n    gitlab_service_ops:rate:prediction{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"runners\",type=\"ci-runners\"}\n    + (1) *\n    gitlab_service_ops:rate:stddev_over_time_1w{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"runners\",type=\"ci-runners\"}\n  ),\n  0\n)\n","format":"time_series","interval":"1m","intervalFactor":3,"legendFormat":"upper normal","refId":"C"},{"expr":"clamp_min(\n  avg by (type) (\n    gitlab_service_ops:rate:prediction{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"runners\",type=\"ci-runners\"}\n    + (-1) *\n    gitlab_service_ops:rate:stddev_over_time_1w{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"runners\",type=\"ci-runners\"}\n  ),\n  0\n)\n","format":"time_series","interval":"1m","intervalFactor":3,"legendFormat":"lower normal","refId":"D"}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"ci-runners Service RPS - Requests per Second","tooltip":{"shared":true,"sort":2,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"short","label":"Operations per Second","logBase":1,"min":0,"show":true},{"format":"short","logBase":1,"max":1,"min":0,"show":false}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":"$PROMETHEUS_DS","decimals":2,"description":"Saturation is a measure of what ratio of a finite resource is currently being utilized. Lower is better.","fieldConfig":{"defaults":{"custom":{}},"overrides":[]},"fill":0,"fillGradient":0,"gridPos":{"h":7,"w":6,"x":18,"y":0},"hiddenSeries":false,"id":8,"legend":{"alignAsTable":true,"avg":true,"current":true,"hideEmpty":true,"max":true,"min":true,"rightSide":false,"show":true,"total":false,"values":true},"lines":true,"linewidth":2,"nullPointMode":"null","options":{"alertThreshold":true},"percentage":false,"pluginVersion":"7.2.0","pointradius":5,"points":false,"renderer":"flot","seriesOverrides":[],"spaceLength":10,"stableId":"service-utilization","stack":false,"steppedLine":false,"targets":[{"expr":"max(\n  max_over_time(\n    gitlab_component_saturation:ratio{environment=\"$environment\",stage=\"$stage\",tier=\"runners\",type=\"ci-runners\"}[$__interval]\n  )\n) by (component)\n","format":"time_series","interval":"1m","intervalFactor":3,"legendFormat":"{{ component }} component","refId":"A"}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"Saturation","tooltip":{"shared":true,"sort":2,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"percentunit","label":"Saturation %","logBase":1,"max":1,"show":true},{"format":"short","logBase":1,"max":1,"min":0,"show":false}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":"$PROMETHEUS_DS","decimals":0,"description":"","fieldConfig":{"defaults":{"custom":{}},"overrides":[]},"fill":0,"fillGradient":0,"gridPos":{"h":7,"w":6,"x":0,"y":6},"hiddenSeries":false,"id":20,"legend":{"alignAsTable":true,"avg":true,"current":true,"hideEmpty":true,"max":true,"min":true,"rightSide":false,"show":true,"sideWidth":null,"total":false,"values":true},"lines":true,"linewidth":2,"links":[],"nullPointMode":"null","options":{"alertThreshold":true},"percentage":false,"pluginVersion":"7.2.0","pointradius":5,"points":false,"renderer":"flot","repeat":null,"seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"expr":"pg_stat_user_tables_n_dead_tup{env=\"$environment\",fqdn=\"$db_instance\",datname=\"$db_database\",relname=~\"$db_top_dead_tup\"}\n","format":"time_series","interval":"1m","intervalFactor":3,"legendFormat":"{{relname}}","refId":"A"}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"Total dead tuples","tooltip":{"shared":true,"sort":2,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"short","label":"","logBase":1,"max":null,"min":0,"show":true},{"format":"short","label":null,"logBase":1,"max":1,"min":0,"show":false}],"yaxis":{"align":false,"alignLevel":null}},{"datasource":null,"fieldConfig":{"defaults":{"custom":{},"displayName":"Status","mappings":[{"from":"0","id":0,"op":"=","text":"Healthy","to":"0","type":2,"value":"0"},{"from":"1","id":1,"op":"=","text":"Warning ðŸ”¥","to":"1","type":2,"value":"1"},{"from":"2","id":2,"op":"=","text":"Warning ðŸ”¥","to":"2","type":2,"value":"2"},{"from":"3","id":3,"op":"=","text":"Degraded ðŸ”¥","to":"3","type":2,"value":"3"},{"from":"4","id":4,"op":"=","text":"Warning ðŸ¥µ","to":"4","type":2,"value":"4"},{"from":"5","id":5,"op":"=","text":"Warning ðŸ”¥ðŸ¥µ","to":"5","type":2,"value":"5"},{"from":"6","id":6,"op":"=","text":"Warning ðŸ”¥ðŸ¥µ","to":"6","type":2,"value":"6"},{"from":"7","id":7,"op":"=","text":"Degraded ðŸ”¥ðŸ¥µ","to":"7","type":2,"value":"7"},{"from":"8","id":8,"op":"=","text":"Warning ðŸ¥µ","to":"8","type":2,"value":"8"},{"from":"9","id":9,"op":"=","text":"Warning ðŸ”¥ðŸ¥µ","to":"9","type":2,"value":"9"},{"from":"10","id":10,"op":"=","text":"Warning ðŸ”¥ðŸ¥µ","to":"10","type":2,"value":"10"},{"from":"11","id":11,"op":"=","text":"Degraded ðŸ”¥ðŸ¥µ","to":"11","type":2,"value":"11"},{"from":"12","id":12,"op":"=","text":"Degraded ðŸ¥µ","to":"12","type":2,"value":"12"},{"from":"13","id":13,"op":"=","text":"Degraded ðŸ”¥ðŸ¥µ","to":"13","type":2,"value":"13"},{"from":"14","id":14,"op":"=","text":"Degraded ðŸ”¥ðŸ¥µ","to":"14","type":2,"value":"14"},{"from":"15","id":15,"op":"=","text":"Degraded ðŸ”¥ðŸ¥µ","to":"15","type":2,"value":"15"}],"nullValueMode":"connected","thresholds":{"mode":"absolute","steps":[{"color":"black","value":null},{"color":"orange","value":1},{"color":"orange","value":2},{"color":"red","value":3},{"color":"orange","value":4},{"color":"orange","value":5},{"color":"orange","value":6},{"color":"red","value":7},{"color":"orange","value":8},{"color":"orange","value":9},{"color":"orange","value":10},{"color":"red","value":11},{"color":"red","value":12},{"color":"red","value":13},{"color":"red","value":14},{"color":"red","value":15}]},"unit":"none"},"overrides":[]},"gridPos":{"h":1,"w":6,"x":6,"y":6},"id":6,"options":{"colorMode":"background","graphMode":"none","justifyMode":"auto","orientation":"vertical","reduceOptions":{"calcs":["lastNotNull"],"fields":"","values":false},"textMode":"auto"},"pluginVersion":"7.2.0","targets":[{"expr":"sum (\n  label_replace(\n    vector(0) and on() (gitlab_service_errors:ratio_1h{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"runners\",type=\"ci-runners\"}),\n    \"period\", \"na\", \"\", \"\"\n  )\n  or\n  label_replace(\n    vector(1) and on() (gitlab_service_errors:ratio_5m{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"runners\",type=\"ci-runners\"} \u003e on(tier, type) group_left() (14.4 * slo:max:events:gitlab_service_errors:ratio{monitor=\"global\",type=\"ci-runners\"})),\n    \"period\", \"5m\", \"\", \"\"\n  )\n  or\n  label_replace(\n    vector(2) and on() (gitlab_service_errors:ratio_1h{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"runners\",type=\"ci-runners\"} \u003e on(tier, type) group_left() (14.4 * slo:max:events:gitlab_service_errors:ratio{monitor=\"global\",type=\"ci-runners\"})),\n    \"period\", \"1h\", \"\", \"\"\n  )\n  or\n  label_replace(\n    vector(4) and on() (gitlab_service_errors:ratio_30m{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"runners\",type=\"ci-runners\"} \u003e on(tier, type) group_left() (6 * slo:max:events:gitlab_service_errors:ratio{monitor=\"global\",type=\"ci-runners\"})),\n    \"period\", \"30m\", \"\", \"\"\n  )\n  or\n  label_replace(\n    vector(8) and on() (gitlab_service_errors:ratio_6h{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"runners\",type=\"ci-runners\"} \u003e on(tier, type) group_left() (6 * slo:max:events:gitlab_service_errors:ratio{monitor=\"global\",type=\"ci-runners\"})),\n    \"period\", \"6h\", \"\", \"\"\n  )\n)\n","format":"time_series","instant":true,"interval":"1m","intervalFactor":3,"legendFormat":"ci-runners Service | Errors","refId":"A"}],"title":"","type":"stat"},{"cards":{"cardPadding":1,"cardRound":2},"color":{"cardColor":"#FA6400","colorScale":"sqrt","colorScheme":"interpolateOranges","exponent":0.5,"mode":"opacity"},"dataFormat":"tsbuckets","datasource":"$PROMETHEUS_DS","fieldConfig":{"defaults":{"custom":{}},"overrides":[]},"gridPos":{"h":7,"w":4.8,"x":9.6,"y":7},"heatmap":{},"hideZeroBuckets":false,"highlightCards":true,"id":11,"legend":{"show":false},"reverseYBuckets":false,"targets":[{"dsType":"influxdb","expr":"sum by (le) (\n  rate(job_queue_duration_seconds_bucket{environment=~\"$environment\", jobs_running_for_project=~\"$jobs_running_for_project\"}[$__interval])\n)\n","format":"heatmap","groupBy":[{"params":["$__interval"],"type":"time"},{"params":["null"],"type":"fill"}],"interval":"$__interval","intervalFactor":1,"legendFormat":"{{le}}","orderByTime":"ASC","refId":"A","select":[[{"params":["value"],"type":"field"},{"params":[],"type":"mean"}]]}],"title":"Pending job queue duration histogram","tooltip":{"show":true,"showHistogram":true},"tooltipDecimals":3,"type":"heatmap","xAxis":{"show":true},"xBucketNumber":null,"xBucketSize":null,"yAxis":{"decimals":2,"format":"s","logBase":1,"max":null,"min":null,"show":true,"splitFactor":null},"yBucketBound":"auto","yBucketNumber":null,"yBucketSize":null},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":"$PROMETHEUS_DS","decimals":0,"description":"","fieldConfig":{"defaults":{"custom":{}},"overrides":[]},"fill":0,"fillGradient":0,"gridPos":{"h":7,"w":4.8,"x":14.399999999999999,"y":7},"hiddenSeries":false,"id":12,"legend":{"alignAsTable":true,"avg":true,"current":true,"hideEmpty":true,"max":true,"min":true,"rightSide":false,"show":true,"sideWidth":null,"total":false,"values":true},"lines":true,"linewidth":2,"links":[],"nullPointMode":"null","options":{"alertThreshold":true},"percentage":false,"pluginVersion":"7.2.0","pointradius":5,"points":false,"renderer":"flot","repeat":null,"seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"expr":"histogram_quantile(\n  0.99,\n  sum by (le, runner_type) (\n    increase(gitlab_ci_queue_size_total_bucket{environment=~\"$environment\"}[$__interval])\n  )\n)\n","format":"time_series","interval":"1m","intervalFactor":3,"legendFormat":"{{runner_type}}","refId":"A"}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"Pending jobs queue size","tooltip":{"shared":true,"sort":2,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"short","label":"","logBase":1,"max":null,"min":0,"show":true},{"format":"short","label":null,"logBase":1,"max":1,"min":0,"show":false}],"yaxis":{"align":false,"alignLevel":null}},{"content":"In short: scheduling of CI/CD jobs to runners fully depends on DB. Any DB problems may affect our ability\nto pass jobs to runners that are asking for them.\n\nThe scheduling is done by using a special SQL query executed on API requests to `/api/v4/jobs/request`. We name\nthis query \"Big Query\". Depending on the type of the runner that asks for a job (instance, group or project)\nthe query is slightly different. The query for `instance_type` runners is most complicated and execution heavy,\nas it includes resolving the \"fair scheduling algorithm\" problem, respecting Pipeline Minutes quotas and checking\nif `instance_type` runners are even enabled for a project.\n\nThe query does also initial handling of runner tags matching.\n\nThe result is next filtered in Rails to fully resolve tags matching, respect the `protected` setting etc. From the\nfinal list of jobs GitLab tries to schedule the first one to the Runner that asked for a job. In case the same\njob was already assigned to another Runner that asked for a job concurrently, GitLab tries - but only once - to\nschedule the second job from the list. If this also fails on SQL transaction (which mostly means that this job also\nwas already scheduled to a different Runner by a different request) the `409 Conflict` response is sent back.\n\nThe Big Query should be executed only on the read-only replicas.\n\nKnown problem indicators:\n- general Patroni service problems,\n- a high number of dead tuples for tables used in the Big Query,\n- a high percentage of dead tuples for tables used in the Big Query,\n- a high number of slow queries on the replicas (usually \u003e50 opm becomes problematic).\n\nDatabase problems can be caused by many different reasons and it's hard to define \"most known problems\".\nHowever, the most popular ones that we've seen regularly are:\n- A significant increase of jobs in the `pending` queue, which makes executions of queries on `ci_builds` much\n  slower.\n- A significant increase of requests to `/api/v4/jobs/request` which triggers more Big Query executions and may\n  be the source of DB slowness.\n- VACUUM or AUTOVACUUM running on the DB (especially on the tables used in the Big Query).\n- Long running transactions (for example sourced by DB migrations) that are blocking DB and causing slower\n  queries execution.\n","datasource":null,"fieldConfig":{"defaults":{"custom":{}},"overrides":[]},"gridPos":{"h":7,"w":4.8,"x":19.2,"y":7},"id":13,"mode":"markdown","options":{"content":"In short: scheduling of CI/CD jobs to runners fully depends on DB. Any DB problems may affect our ability\nto pass jobs to runners that are asking for them.\n\nThe scheduling is done by using a special SQL query executed on API requests to `/api/v4/jobs/request`. We name\nthis query \"Big Query\". Depending on the type of the runner that asks for a job (instance, group or project)\nthe query is slightly different. The query for `instance_type` runners is most complicated and execution heavy,\nas it includes resolving the \"fair scheduling algorithm\" problem, respecting Pipeline Minutes quotas and checking\nif `instance_type` runners are even enabled for a project.\n\nThe query does also initial handling of runner tags matching.\n\nThe result is next filtered in Rails to fully resolve tags matching, respect the `protected` setting etc. From the\nfinal list of jobs GitLab tries to schedule the first one to the Runner that asked for a job. In case the same\njob was already assigned to another Runner that asked for a job concurrently, GitLab tries - but only once - to\nschedule the second job from the list. If this also fails on SQL transaction (which mostly means that this job also\nwas already scheduled to a different Runner by a different request) the `409 Conflict` response is sent back.\n\nThe Big Query should be executed only on the read-only replicas.\n\nKnown problem indicators:\n- general Patroni service problems,\n- a high number of dead tuples for tables used in the Big Query,\n- a high percentage of dead tuples for tables used in the Big Query,\n- a high number of slow queries on the replicas (usually \u003e50 opm becomes problematic).\n\nDatabase problems can be caused by many different reasons and it's hard to define \"most known problems\".\nHowever, the most popular ones that we've seen regularly are:\n- A significant increase of jobs in the `pending` queue, which makes executions of queries on `ci_builds` much\n  slower.\n- A significant increase of requests to `/api/v4/jobs/request` which triggers more Big Query executions and may\n  be the source of DB slowness.\n- VACUUM or AUTOVACUUM running on the DB (especially on the tables used in the Big Query).\n- Long running transactions (for example sourced by DB migrations) that are blocking DB and causing slower\n  queries execution.\n","mode":"markdown"},"pluginVersion":"7.1.0","title":"database caused incident notes","type":"text"},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":"$PROMETHEUS_DS","decimals":0,"description":"","fieldConfig":{"defaults":{"custom":{}},"overrides":[]},"fill":0,"fillGradient":0,"gridPos":{"h":7,"w":6,"x":0,"y":13},"hiddenSeries":false,"id":24,"legend":{"alignAsTable":true,"avg":true,"current":true,"hideEmpty":true,"max":true,"min":true,"rightSide":false,"show":true,"sideWidth":null,"total":false,"values":true},"lines":true,"linewidth":2,"links":[],"nullPointMode":"null","options":{"alertThreshold":true},"percentage":false,"pluginVersion":"7.2.0","pointradius":5,"points":false,"renderer":"flot","seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"expr":"pg_stat_user_tables_n_live_tup{env=\"$environment\",fqdn=\"$db_instance\",datname=\"$db_database\",relname=~\"$db_top_dead_tup\"}\n","format":"time_series","interval":"1m","intervalFactor":3,"legendFormat":"{{relname}}","refId":"A"}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"Total live tuples","tooltip":{"shared":true,"sort":2,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"$$hashKey":"object:579","format":"short","label":"","logBase":1,"max":null,"min":0,"show":true},{"$$hashKey":"object:580","format":"short","label":null,"logBase":1,"max":1,"min":0,"show":false}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":"$PROMETHEUS_DS","decimals":2,"description":"The operation rate is the sum total of all requests being handle for all components within this service. Note that a single user request can lead to requests to multiple components. Higher is busier.","fieldConfig":{"defaults":{"custom":{}},"overrides":[]},"fill":0,"fillGradient":0,"gridPos":{"h":6,"w":6,"x":12,"y":14},"hiddenSeries":false,"id":18,"legend":{"alignAsTable":true,"avg":true,"current":true,"hideEmpty":true,"max":true,"min":true,"rightSide":false,"show":false,"total":false,"values":true},"lines":true,"linewidth":2,"nullPointMode":"null","options":{"alertThreshold":true},"percentage":false,"pluginVersion":"7.2.0","pointradius":5,"points":false,"renderer":"flot","seriesOverrides":[{"alias":"patroni RPS","color":"#E7D551","zindex":3},{"alias":"last week","color":"#dddddd80","dashLength":4,"dashes":true,"fill":0,"legend":true,"lines":true,"linewidth":1,"nullPointMode":"connected","spaceLength":2,"zindex":-3},{"alias":"upper normal","color":"#73BF69","dashLength":8,"dashes":true,"fillBelowTo":"lower normal","legend":false,"lines":false,"linewidth":1,"nullPointMode":"connected","spaceLength":8,"zindex":-3},{"alias":"lower normal","color":"#73BF69","dashLength":8,"dashes":true,"legend":false,"lines":false,"linewidth":1,"nullPointMode":"connected","spaceLength":8,"zindex":-3}],"spaceLength":10,"stableId":"service-patroni-ops-rate","stack":false,"steppedLine":false,"targets":[{"expr":"avg_over_time(gitlab_service_ops:rate_5m{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"db\",type=\"patroni\"}[$__interval])\n","format":"time_series","interval":"1m","intervalFactor":3,"legendFormat":"patroni RPS","refId":"A"},{"expr":"gitlab_service_ops:rate_5m{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"db\",type=\"patroni\"} offset 1w\n","format":"time_series","interval":"1m","intervalFactor":3,"legendFormat":"last week","refId":"B"},{"expr":"clamp_min(\n  avg by (type) (\n    gitlab_service_ops:rate:prediction{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"db\",type=\"patroni\"}\n    + (1) *\n    gitlab_service_ops:rate:stddev_over_time_1w{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"db\",type=\"patroni\"}\n  ),\n  0\n)\n","format":"time_series","interval":"1m","intervalFactor":3,"legendFormat":"upper normal","refId":"C"},{"expr":"clamp_min(\n  avg by (type) (\n    gitlab_service_ops:rate:prediction{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"db\",type=\"patroni\"}\n    + (-1) *\n    gitlab_service_ops:rate:stddev_over_time_1w{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"db\",type=\"patroni\"}\n  ),\n  0\n)\n","format":"time_series","interval":"1m","intervalFactor":3,"legendFormat":"lower normal","refId":"D"}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"patroni Service RPS - Requests per Second","tooltip":{"shared":true,"sort":2,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"short","label":"","logBase":1,"min":0,"show":true},{"format":"short","logBase":1,"max":1,"min":0,"show":false}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":"$PROMETHEUS_DS","decimals":2,"description":"Saturation is a measure of what ratio of a finite resource is currently being utilized. Lower is better.","fieldConfig":{"defaults":{"custom":{}},"overrides":[]},"fill":0,"fillGradient":0,"gridPos":{"h":6,"w":6,"x":18,"y":14},"hiddenSeries":false,"id":19,"legend":{"alignAsTable":true,"avg":true,"current":true,"hideEmpty":true,"max":true,"min":true,"rightSide":false,"show":false,"total":false,"values":true},"lines":true,"linewidth":1,"nullPointMode":"null","options":{"alertThreshold":true},"percentage":false,"pluginVersion":"7.2.0","pointradius":5,"points":false,"renderer":"flot","seriesOverrides":[],"spaceLength":10,"stableId":"service-utilization","stack":false,"steppedLine":false,"targets":[{"expr":"max(\n  max_over_time(\n    gitlab_component_saturation:ratio{environment=\"$environment\",stage=\"$stage\",tier=\"db\",type=\"patroni\"}[$__interval]\n  )\n) by (component)\n","format":"time_series","interval":"1m","intervalFactor":3,"legendFormat":"{{ component }} component","refId":"A"}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"Saturation","tooltip":{"shared":true,"sort":2,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"percentunit","label":"","logBase":1,"max":1,"show":true},{"format":"short","logBase":1,"max":1,"min":0,"show":false}],"yaxis":{"align":false,"alignLevel":null}},{"datasource":null,"fieldConfig":{"defaults":{"custom":{},"displayName":"Status","mappings":[{"from":"0","id":0,"op":"=","text":"Healthy","to":"0","type":2,"value":"0"},{"from":"1","id":1,"op":"=","text":"Warning ðŸ”¥","to":"1","type":2,"value":"1"},{"from":"2","id":2,"op":"=","text":"Warning ðŸ”¥","to":"2","type":2,"value":"2"},{"from":"3","id":3,"op":"=","text":"Degraded ðŸ”¥","to":"3","type":2,"value":"3"},{"from":"4","id":4,"op":"=","text":"Warning ðŸ¥µ","to":"4","type":2,"value":"4"},{"from":"5","id":5,"op":"=","text":"Warning ðŸ”¥ðŸ¥µ","to":"5","type":2,"value":"5"},{"from":"6","id":6,"op":"=","text":"Warning ðŸ”¥ðŸ¥µ","to":"6","type":2,"value":"6"},{"from":"7","id":7,"op":"=","text":"Degraded ðŸ”¥ðŸ¥µ","to":"7","type":2,"value":"7"},{"from":"8","id":8,"op":"=","text":"Warning ðŸ¥µ","to":"8","type":2,"value":"8"},{"from":"9","id":9,"op":"=","text":"Warning ðŸ”¥ðŸ¥µ","to":"9","type":2,"value":"9"},{"from":"10","id":10,"op":"=","text":"Warning ðŸ”¥ðŸ¥µ","to":"10","type":2,"value":"10"},{"from":"11","id":11,"op":"=","text":"Degraded ðŸ”¥ðŸ¥µ","to":"11","type":2,"value":"11"},{"from":"12","id":12,"op":"=","text":"Degraded ðŸ¥µ","to":"12","type":2,"value":"12"},{"from":"13","id":13,"op":"=","text":"Degraded ðŸ”¥ðŸ¥µ","to":"13","type":2,"value":"13"},{"from":"14","id":14,"op":"=","text":"Degraded ðŸ”¥ðŸ¥µ","to":"14","type":2,"value":"14"},{"from":"15","id":15,"op":"=","text":"Degraded ðŸ”¥ðŸ¥µ","to":"15","type":2,"value":"15"}],"nullValueMode":"connected","thresholds":{"mode":"absolute","steps":[{"color":"black","value":null},{"color":"orange","value":1},{"color":"orange","value":2},{"color":"red","value":3},{"color":"orange","value":4},{"color":"orange","value":5},{"color":"orange","value":6},{"color":"red","value":7},{"color":"orange","value":8},{"color":"orange","value":9},{"color":"orange","value":10},{"color":"red","value":11},{"color":"red","value":12},{"color":"red","value":13},{"color":"red","value":14},{"color":"red","value":15}]},"unit":"none"},"overrides":[]},"gridPos":{"h":1,"w":6,"x":0,"y":20},"id":4,"options":{"colorMode":"background","graphMode":"none","justifyMode":"auto","orientation":"vertical","reduceOptions":{"calcs":["lastNotNull"],"fields":"","values":false},"textMode":"auto"},"pluginVersion":"7.2.0","targets":[{"expr":"sum(\n  label_replace(\n    vector(0) and on() (gitlab_service_apdex:ratio_1h{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"runners\",type=\"ci-runners\"}),\n    \"period\", \"na\", \"\", \"\"\n  )\n  or\n  label_replace(\n    vector(1) and on () (gitlab_service_apdex:ratio_5m{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"runners\",type=\"ci-runners\"} \u003c on(tier, type) group_left() (1 - (14.4 * (1 - slo:min:events:gitlab_service_apdex:ratio{monitor=\"global\",type=\"ci-runners\"})))),\n    \"period\", \"5m\", \"\", \"\"\n  )\n  or\n  label_replace(\n    vector(2) and on () (gitlab_service_apdex:ratio_1h{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"runners\",type=\"ci-runners\"} \u003c on(tier, type) group_left() (1 - (14.4 * (1 - slo:min:events:gitlab_service_apdex:ratio{monitor=\"global\",type=\"ci-runners\"})))),\n    \"period\", \"1h\", \"\", \"\"\n  )\n  or\n  label_replace(\n    vector(4) and on () (gitlab_service_apdex:ratio_30m{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"runners\",type=\"ci-runners\"} \u003c on(tier, type) group_left() (1 - (6 * (1 - slo:min:events:gitlab_service_apdex:ratio{monitor=\"global\",type=\"ci-runners\"})))),\n    \"period\", \"30m\", \"\", \"\"\n  )\n  or\n  label_replace(\n    vector(8) and on () (gitlab_service_apdex:ratio_6h{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"runners\",type=\"ci-runners\"} \u003c on(tier, type) group_left() (1 - (6 * (1 - slo:min:events:gitlab_service_apdex:ratio{monitor=\"global\",type=\"ci-runners\"})))),\n    \"period\", \"6h\", \"\", \"\"\n  )\n)\n","format":"time_series","instant":true,"interval":"1m","intervalFactor":3,"legendFormat":"ci-runners Service | Latency/Apdex","refId":"A"}],"title":"","type":"stat"},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":"$PROMETHEUS_DS","decimals":0,"description":"","fieldConfig":{"defaults":{"custom":{}},"overrides":[]},"fill":0,"fillGradient":0,"gridPos":{"h":8,"w":8,"x":16,"y":20},"hiddenSeries":false,"id":22,"legend":{"alignAsTable":true,"avg":true,"current":true,"hideEmpty":true,"max":true,"min":true,"rightSide":false,"show":true,"sideWidth":null,"total":false,"values":true},"lines":true,"linewidth":2,"links":[],"nullPointMode":"null","options":{"alertThreshold":true},"percentage":false,"pluginVersion":"7.2.0","pointradius":5,"points":false,"renderer":"flot","repeat":null,"seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"expr":"rate(pg_slow_queries{environment=\"$environment\",fqdn=~\"$db_instances\"}[$__interval]) * 60\n","format":"time_series","interval":"1m","intervalFactor":3,"legendFormat":"{{fqdn}}","refId":"A"}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"Slow queries","tooltip":{"shared":true,"sort":2,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"opm","label":"","logBase":1,"max":null,"min":0,"show":true},{"format":"short","label":null,"logBase":1,"max":1,"min":0,"show":false}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":"$PROMETHEUS_DS","decimals":0,"description":"","fieldConfig":{"defaults":{"custom":{}},"overrides":[]},"fill":1,"fillGradient":0,"gridPos":{"h":7,"w":4.8,"x":0,"y":21},"hiddenSeries":false,"id":9,"legend":{"alignAsTable":true,"avg":true,"current":true,"hideEmpty":true,"max":true,"min":true,"rightSide":false,"show":true,"sideWidth":null,"total":false,"values":true},"lines":true,"linewidth":2,"links":[],"nullPointMode":"null","options":{"alertThreshold":true},"percentage":false,"pluginVersion":"7.2.0","pointradius":5,"points":false,"renderer":"flot","repeat":null,"seriesOverrides":[],"spaceLength":10,"stack":true,"steppedLine":false,"targets":[{"expr":"sum by(shard) (gitlab_runner_jobs{instance=~\"${runner_manager:pipe}\"})","format":"time_series","interval":"1m","intervalFactor":3,"legendFormat":"{{ shard }}","refId":"A"}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"Jobs running on GitLab Inc. runners (by shard)","tooltip":{"shared":true,"sort":2,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"short","label":"","logBase":1,"max":null,"min":0,"show":true},{"format":"short","label":null,"logBase":1,"max":1,"min":0,"show":false}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":true,"dashLength":10,"dashes":false,"datasource":"$PROMETHEUS_DS","decimals":0,"description":"","fieldConfig":{"defaults":{"custom":{}},"overrides":[]},"fill":1,"fillGradient":0,"gridPos":{"h":7,"w":4.8,"x":4.8,"y":21},"hiddenSeries":false,"id":10,"legend":{"alignAsTable":true,"avg":true,"current":true,"hideEmpty":true,"max":true,"min":true,"rightSide":false,"show":true,"sideWidth":null,"total":false,"values":true},"lines":false,"linewidth":2,"links":[],"nullPointMode":"null","options":{"alertThreshold":true},"percentage":false,"pluginVersion":"7.2.0","pointradius":5,"points":false,"renderer":"flot","repeat":null,"seriesOverrides":[],"spaceLength":10,"stack":true,"steppedLine":false,"targets":[{"expr":"sum by(shard) (\n  increase(gitlab_runner_jobs_total{instance=~\"${runner_manager:pipe}\"}[$__interval])\n)\n","format":"time_series","interval":"1m","intervalFactor":3,"legendFormat":"{{ shard }}","refId":"A"}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"Jobs started on runners (by shard)","tooltip":{"shared":true,"sort":2,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"short","label":"","logBase":1,"max":null,"min":0,"show":true},{"format":"short","label":null,"logBase":1,"max":1,"min":0,"show":false}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":"$PROMETHEUS_DS","decimals":2,"description":"Apdex is a measure of requests that complete within a tolerable period of time for the service. Higher is better.","fieldConfig":{"defaults":{"custom":{},"links":[{"targetBlank":true,"title":"patroni Service Apdex SLO Analysis","url":"/d/alerts-service_slo_apdex?${__url_time_range}\u0026${__all_variables}\u0026var-type=patroni\u0026var-stage=$stage"}]},"overrides":[]},"fill":0,"fillGradient":0,"gridPos":{"h":5,"w":6,"x":0,"y":28},"hiddenSeries":false,"id":14,"legend":{"alignAsTable":true,"avg":true,"current":true,"hideEmpty":true,"max":true,"min":true,"rightSide":false,"show":false,"total":false,"values":true},"lines":true,"linewidth":2,"nullPointMode":"null","options":{"alertThreshold":true},"percentage":false,"pluginVersion":"7.2.0","pointradius":5,"points":false,"renderer":"flot","seriesOverrides":[{"alias":"6h Degradation SLO (5% of monthly error budget)","color":"#FF4500","dashLength":4,"dashes":true,"legend":true,"lines":true,"linewidth":2,"nullPointMode":"connected","spaceLength":10,"zindex":-2},{"alias":"1h Outage SLO (2% of monthly error budget)","color":"#F2495C","dashLength":4,"dashes":true,"legend":true,"lines":true,"linewidth":4,"nullPointMode":"connected","spaceLength":4,"zindex":-2},{"alias":"SLO","color":"#FF4500","dashLength":4,"dashes":true,"legend":true,"lines":true,"linewidth":4,"nullPointMode":"connected","spaceLength":4,"zindex":-2},{"alias":"patroni apdex","color":"#E7D551","zindex":3},{"alias":"patroni apdex avg","color":"#5794F2","dashLength":1,"fillBelowTo":"patroni apdex","linewidth":1,"spaceLength":1,"zindex":-3},{"alias":"last week","color":"#dddddd80","dashLength":4,"dashes":true,"fill":0,"legend":true,"lines":true,"linewidth":1,"nullPointMode":"connected","spaceLength":2,"zindex":-3}],"spaceLength":10,"stableId":"service-patroni-apdex","stack":false,"steppedLine":false,"targets":[{"expr":"min_over_time(gitlab_service_apdex:ratio_5m{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"db\",type=\"patroni\"}[$__interval])\n","format":"time_series","interval":"1m","intervalFactor":3,"legendFormat":"patroni apdex","refId":"A"},{"expr":"(1 - 6 * (1 - avg(slo:min:events:gitlab_service_apdex:ratio{monitor=\"global\",type=\"patroni\"})))\n","format":"time_series","interval":"5m","intervalFactor":3,"legendFormat":"6h Degradation SLO (5% of monthly error budget)","refId":"B"},{"expr":"(1 - 14.4 * (1 - avg(slo:min:events:gitlab_service_apdex:ratio{monitor=\"global\",type=\"patroni\"})))\n","format":"time_series","interval":"5m","intervalFactor":3,"legendFormat":"1h Outage SLO (2% of monthly error budget)","refId":"C"},{"expr":"avg_over_time(gitlab_service_apdex:ratio_5m{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"db\",type=\"patroni\"}[$__interval])\n","format":"time_series","interval":"1m","intervalFactor":3,"legendFormat":"patroni apdex avg","refId":"D"},{"expr":"clamp_min(\n  gitlab_service_apdex:ratio_5m{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"db\",type=\"patroni\"} offset 1w\n,\n  scalar(min((1 - 14.4 * (1 - avg(slo:min:events:gitlab_service_apdex:ratio{monitor=\"global\",type=\"patroni\"})))\n))\n)\n","format":"time_series","interval":"1m","intervalFactor":3,"legendFormat":"last week","refId":"E"}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"patroni Service Apdex","tooltip":{"shared":true,"sort":1,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"percentunit","label":"","logBase":1,"max":1,"show":true},{"format":"short","logBase":1,"max":1,"min":0,"show":false}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":"$PROMETHEUS_DS","decimals":2,"description":"Error rates are a measure of unhandled service exceptions per second. Client errors are excluded when possible. Lower is better","fieldConfig":{"defaults":{"custom":{},"links":[{"targetBlank":true,"title":"patroni Service Error-Rate SLO Analysis","url":"/d/alerts-service_slo_error?${__url_time_range}\u0026${__all_variables}\u0026var-type=patroni\u0026var-stage=$stage"}]},"overrides":[]},"fill":0,"fillGradient":0,"gridPos":{"h":5,"w":6,"x":6,"y":28},"hiddenSeries":false,"id":16,"legend":{"alignAsTable":true,"avg":true,"current":true,"hideEmpty":true,"max":true,"min":true,"rightSide":false,"show":false,"total":false,"values":true},"lines":true,"linewidth":2,"nullPointMode":"null","options":{"alertThreshold":true},"percentage":false,"pluginVersion":"7.2.0","pointradius":5,"points":false,"renderer":"flot","seriesOverrides":[{"alias":"6h Degradation SLO (5% of monthly error budget)","color":"#FF4500","dashLength":4,"dashes":true,"legend":true,"lines":true,"linewidth":2,"nullPointMode":"connected","spaceLength":10,"zindex":-2},{"alias":"1h Outage SLO (2% of monthly error budget)","color":"#F2495C","dashLength":4,"dashes":true,"legend":true,"lines":true,"linewidth":4,"nullPointMode":"connected","spaceLength":4,"zindex":-2},{"alias":"patroni error ratio","color":"#E7D551","fillBelowTo":"patroni error ratio avg","zindex":3},{"alias":"patroni error ratio avg","color":"#5794F2","dashLength":1,"fillGradient":10,"linewidth":1,"spaceLength":1,"zindex":-3},{"alias":"last week","color":"#dddddd80","dashLength":4,"dashes":true,"fill":0,"legend":true,"lines":true,"linewidth":1,"nullPointMode":"connected","spaceLength":2,"zindex":-3}],"spaceLength":10,"stableId":"service-patroni-error-rate","stack":false,"steppedLine":false,"targets":[{"expr":"clamp_max(\n  max_over_time(gitlab_service_errors:ratio_5m{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"db\",type=\"patroni\"}[$__interval])\n,\n  1\n)\n","format":"time_series","interval":"1m","intervalFactor":3,"legendFormat":"patroni error ratio","refId":"A"},{"expr":"(6 * avg(slo:max:events:gitlab_service_errors:ratio{monitor=\"global\",type=\"patroni\"}))\n","format":"time_series","interval":"5m","intervalFactor":3,"legendFormat":"6h Degradation SLO (5% of monthly error budget)","refId":"B"},{"expr":"(14.4 * avg(slo:max:events:gitlab_service_errors:ratio{monitor=\"global\",type=\"patroni\"}))\n","format":"time_series","interval":"5m","intervalFactor":3,"legendFormat":"1h Outage SLO (2% of monthly error budget)","refId":"C"},{"expr":"clamp_max(\n  avg_over_time(gitlab_service_errors:ratio_5m{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"db\",type=\"patroni\"}[$__interval])\n,\n  1\n)\n","format":"time_series","interval":"1m","intervalFactor":3,"legendFormat":"patroni error ratio avg","refId":"D"},{"expr":"clamp_max(\n  gitlab_service_errors:ratio_5m{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"db\",type=\"patroni\"} offset 1w\n,\n  scalar(max((14.4 * avg(slo:max:events:gitlab_service_errors:ratio{monitor=\"global\",type=\"patroni\"}))\n))\n)\n","format":"time_series","interval":"1m","intervalFactor":3,"legendFormat":"last week","refId":"E"}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"patroni Service Error Ratio","tooltip":{"shared":true,"sort":2,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"percentunit","label":"","logBase":1,"min":0,"show":true},{"format":"short","logBase":1,"max":1,"min":0,"show":false}],"yaxis":{"align":false,"alignLevel":null}},{"datasource":null,"fieldConfig":{"defaults":{"custom":{},"displayName":"Status","mappings":[{"from":"0","id":0,"op":"=","text":"Healthy","to":"0","type":2,"value":"0"},{"from":"1","id":1,"op":"=","text":"Warning ðŸ”¥","to":"1","type":2,"value":"1"},{"from":"2","id":2,"op":"=","text":"Warning ðŸ”¥","to":"2","type":2,"value":"2"},{"from":"3","id":3,"op":"=","text":"Degraded ðŸ”¥","to":"3","type":2,"value":"3"},{"from":"4","id":4,"op":"=","text":"Warning ðŸ¥µ","to":"4","type":2,"value":"4"},{"from":"5","id":5,"op":"=","text":"Warning ðŸ”¥ðŸ¥µ","to":"5","type":2,"value":"5"},{"from":"6","id":6,"op":"=","text":"Warning ðŸ”¥ðŸ¥µ","to":"6","type":2,"value":"6"},{"from":"7","id":7,"op":"=","text":"Degraded ðŸ”¥ðŸ¥µ","to":"7","type":2,"value":"7"},{"from":"8","id":8,"op":"=","text":"Warning ðŸ¥µ","to":"8","type":2,"value":"8"},{"from":"9","id":9,"op":"=","text":"Warning ðŸ”¥ðŸ¥µ","to":"9","type":2,"value":"9"},{"from":"10","id":10,"op":"=","text":"Warning ðŸ”¥ðŸ¥µ","to":"10","type":2,"value":"10"},{"from":"11","id":11,"op":"=","text":"Degraded ðŸ”¥ðŸ¥µ","to":"11","type":2,"value":"11"},{"from":"12","id":12,"op":"=","text":"Degraded ðŸ¥µ","to":"12","type":2,"value":"12"},{"from":"13","id":13,"op":"=","text":"Degraded ðŸ”¥ðŸ¥µ","to":"13","type":2,"value":"13"},{"from":"14","id":14,"op":"=","text":"Degraded ðŸ”¥ðŸ¥µ","to":"14","type":2,"value":"14"},{"from":"15","id":15,"op":"=","text":"Degraded ðŸ”¥ðŸ¥µ","to":"15","type":2,"value":"15"}],"nullValueMode":"connected","thresholds":{"mode":"absolute","steps":[{"color":"black","value":null},{"color":"orange","value":1},{"color":"orange","value":2},{"color":"red","value":3},{"color":"orange","value":4},{"color":"orange","value":5},{"color":"orange","value":6},{"color":"red","value":7},{"color":"orange","value":8},{"color":"orange","value":9},{"color":"orange","value":10},{"color":"red","value":11},{"color":"red","value":12},{"color":"red","value":13},{"color":"red","value":14},{"color":"red","value":15}]},"unit":"none"},"overrides":[]},"gridPos":{"h":1,"w":6,"x":0,"y":33},"id":15,"options":{"colorMode":"background","graphMode":"none","justifyMode":"auto","orientation":"vertical","reduceOptions":{"calcs":["lastNotNull"],"fields":"","values":false},"textMode":"auto"},"pluginVersion":"7.2.0","targets":[{"expr":"sum(\n  label_replace(\n    vector(0) and on() (gitlab_service_apdex:ratio_1h{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"db\",type=\"patroni\"}),\n    \"period\", \"na\", \"\", \"\"\n  )\n  or\n  label_replace(\n    vector(1) and on () (gitlab_service_apdex:ratio_5m{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"db\",type=\"patroni\"} \u003c on(tier, type) group_left() (1 - (14.4 * (1 - slo:min:events:gitlab_service_apdex:ratio{monitor=\"global\",type=\"patroni\"})))),\n    \"period\", \"5m\", \"\", \"\"\n  )\n  or\n  label_replace(\n    vector(2) and on () (gitlab_service_apdex:ratio_1h{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"db\",type=\"patroni\"} \u003c on(tier, type) group_left() (1 - (14.4 * (1 - slo:min:events:gitlab_service_apdex:ratio{monitor=\"global\",type=\"patroni\"})))),\n    \"period\", \"1h\", \"\", \"\"\n  )\n  or\n  label_replace(\n    vector(4) and on () (gitlab_service_apdex:ratio_30m{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"db\",type=\"patroni\"} \u003c on(tier, type) group_left() (1 - (6 * (1 - slo:min:events:gitlab_service_apdex:ratio{monitor=\"global\",type=\"patroni\"})))),\n    \"period\", \"30m\", \"\", \"\"\n  )\n  or\n  label_replace(\n    vector(8) and on () (gitlab_service_apdex:ratio_6h{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"db\",type=\"patroni\"} \u003c on(tier, type) group_left() (1 - (6 * (1 - slo:min:events:gitlab_service_apdex:ratio{monitor=\"global\",type=\"patroni\"})))),\n    \"period\", \"6h\", \"\", \"\"\n  )\n)\n","format":"time_series","instant":true,"interval":"1m","intervalFactor":3,"legendFormat":"patroni Service | Latency/Apdex","refId":"A"}],"title":"","type":"stat"},{"datasource":null,"fieldConfig":{"defaults":{"custom":{},"displayName":"Status","mappings":[{"from":"0","id":0,"op":"=","text":"Healthy","to":"0","type":2,"value":"0"},{"from":"1","id":1,"op":"=","text":"Warning ðŸ”¥","to":"1","type":2,"value":"1"},{"from":"2","id":2,"op":"=","text":"Warning ðŸ”¥","to":"2","type":2,"value":"2"},{"from":"3","id":3,"op":"=","text":"Degraded ðŸ”¥","to":"3","type":2,"value":"3"},{"from":"4","id":4,"op":"=","text":"Warning ðŸ¥µ","to":"4","type":2,"value":"4"},{"from":"5","id":5,"op":"=","text":"Warning ðŸ”¥ðŸ¥µ","to":"5","type":2,"value":"5"},{"from":"6","id":6,"op":"=","text":"Warning ðŸ”¥ðŸ¥µ","to":"6","type":2,"value":"6"},{"from":"7","id":7,"op":"=","text":"Degraded ðŸ”¥ðŸ¥µ","to":"7","type":2,"value":"7"},{"from":"8","id":8,"op":"=","text":"Warning ðŸ¥µ","to":"8","type":2,"value":"8"},{"from":"9","id":9,"op":"=","text":"Warning ðŸ”¥ðŸ¥µ","to":"9","type":2,"value":"9"},{"from":"10","id":10,"op":"=","text":"Warning ðŸ”¥ðŸ¥µ","to":"10","type":2,"value":"10"},{"from":"11","id":11,"op":"=","text":"Degraded ðŸ”¥ðŸ¥µ","to":"11","type":2,"value":"11"},{"from":"12","id":12,"op":"=","text":"Degraded ðŸ¥µ","to":"12","type":2,"value":"12"},{"from":"13","id":13,"op":"=","text":"Degraded ðŸ”¥ðŸ¥µ","to":"13","type":2,"value":"13"},{"from":"14","id":14,"op":"=","text":"Degraded ðŸ”¥ðŸ¥µ","to":"14","type":2,"value":"14"},{"from":"15","id":15,"op":"=","text":"Degraded ðŸ”¥ðŸ¥µ","to":"15","type":2,"value":"15"}],"nullValueMode":"connected","thresholds":{"mode":"absolute","steps":[{"color":"black","value":null},{"color":"orange","value":1},{"color":"orange","value":2},{"color":"red","value":3},{"color":"orange","value":4},{"color":"orange","value":5},{"color":"orange","value":6},{"color":"red","value":7},{"color":"orange","value":8},{"color":"orange","value":9},{"color":"orange","value":10},{"color":"red","value":11},{"color":"red","value":12},{"color":"red","value":13},{"color":"red","value":14},{"color":"red","value":15}]},"unit":"none"},"overrides":[]},"gridPos":{"h":1,"w":6,"x":6,"y":33},"id":17,"options":{"colorMode":"background","graphMode":"none","justifyMode":"auto","orientation":"vertical","reduceOptions":{"calcs":["lastNotNull"],"fields":"","values":false},"textMode":"auto"},"pluginVersion":"7.2.0","targets":[{"expr":"sum (\n  label_replace(\n    vector(0) and on() (gitlab_service_errors:ratio_1h{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"db\",type=\"patroni\"}),\n    \"period\", \"na\", \"\", \"\"\n  )\n  or\n  label_replace(\n    vector(1) and on() (gitlab_service_errors:ratio_5m{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"db\",type=\"patroni\"} \u003e on(tier, type) group_left() (14.4 * slo:max:events:gitlab_service_errors:ratio{monitor=\"global\",type=\"patroni\"})),\n    \"period\", \"5m\", \"\", \"\"\n  )\n  or\n  label_replace(\n    vector(2) and on() (gitlab_service_errors:ratio_1h{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"db\",type=\"patroni\"} \u003e on(tier, type) group_left() (14.4 * slo:max:events:gitlab_service_errors:ratio{monitor=\"global\",type=\"patroni\"})),\n    \"period\", \"1h\", \"\", \"\"\n  )\n  or\n  label_replace(\n    vector(4) and on() (gitlab_service_errors:ratio_30m{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"db\",type=\"patroni\"} \u003e on(tier, type) group_left() (6 * slo:max:events:gitlab_service_errors:ratio{monitor=\"global\",type=\"patroni\"})),\n    \"period\", \"30m\", \"\", \"\"\n  )\n  or\n  label_replace(\n    vector(8) and on() (gitlab_service_errors:ratio_6h{environment=\"$environment\",monitor=\"global\",stage=\"$stage\",tier=\"db\",type=\"patroni\"} \u003e on(tier, type) group_left() (6 * slo:max:events:gitlab_service_errors:ratio{monitor=\"global\",type=\"patroni\"})),\n    \"period\", \"6h\", \"\", \"\"\n  )\n)\n","format":"time_series","instant":true,"interval":"1m","intervalFactor":3,"legendFormat":"patroni Service | Errors","refId":"A"}],"title":"","type":"stat"},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":"$PROMETHEUS_DS","decimals":0,"description":"","fieldConfig":{"defaults":{"custom":{}},"overrides":[]},"fill":0,"fillGradient":0,"gridPos":{"h":8,"w":8,"x":8,"y":34},"hiddenSeries":false,"id":21,"legend":{"alignAsTable":true,"avg":true,"current":true,"hideEmpty":true,"max":true,"min":true,"rightSide":false,"show":true,"sideWidth":null,"total":false,"values":true},"lines":true,"linewidth":2,"links":[],"nullPointMode":"null","options":{"alertThreshold":true},"percentage":false,"pluginVersion":"7.2.0","pointradius":5,"points":false,"renderer":"flot","repeat":null,"seriesOverrides":[],"spaceLength":10,"stack":false,"steppedLine":false,"targets":[{"expr":"pg_stat_user_tables_n_dead_tup{env=\"$environment\",fqdn=\"$db_instance\",datname=\"$db_database\",relname=~\"$db_top_dead_tup\"}\n/\n(\n  pg_stat_user_tables_n_live_tup{env=\"$environment\",fqdn=\"$db_instance\",datname=\"$db_database\",relname=~\"$db_top_dead_tup\"}\n  +\n  pg_stat_user_tables_n_dead_tup{env=\"$environment\",fqdn=\"$db_instance\",datname=\"$db_database\",relname=~\"$db_top_dead_tup\"}\n)\n","format":"time_series","interval":"1m","intervalFactor":3,"legendFormat":"{{relname}}","refId":"A"}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"Dead tuples percentage","tooltip":{"shared":true,"sort":2,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"percentunit","label":"","logBase":1,"max":null,"min":0,"show":true},{"format":"short","label":null,"logBase":1,"max":1,"min":0,"show":false}],"yaxis":{"align":false,"alignLevel":null}},{"aliasColors":{},"bars":false,"dashLength":10,"dashes":false,"datasource":"$PROMETHEUS_DS","decimals":0,"description":"","fieldConfig":{"defaults":{"custom":{}},"overrides":[]},"fill":0,"fillGradient":0,"gridPos":{"h":8,"w":24,"x":0,"y":42},"hiddenSeries":false,"id":23,"legend":{"alignAsTable":true,"avg":true,"current":true,"hideEmpty":true,"max":true,"min":true,"rightSide":false,"show":true,"sideWidth":null,"total":false,"values":true},"lines":true,"linewidth":2,"links":[],"nullPointMode":"null","options":{"alertThreshold":true},"percentage":false,"pluginVersion":"7.2.0","pointradius":5,"points":false,"renderer":"flot","repeat":null,"seriesOverrides":[],"spaceLength":10,"stableId":"builds-queue-big-query-duration","stack":false,"steppedLine":false,"targets":[{"expr":"histogram_quantile(\n  0.50,\n  sum by (le, runner_type) (\n    rate(\n      gitlab_ci_queue_retrieval_duration_seconds_bucket{\n        environment=\"$environment\",\n        stage=\"$stage\",\n        runner_type=~\"${runner_type:pipe}\"\n      }[$__interval]\n    )\n  )\n)\n","format":"time_series","interval":"1m","intervalFactor":3,"legendFormat":"{{ runner_type }} - p50","refId":"A"},{"expr":"histogram_quantile(\n  0.90,\n  sum by (le, runner_type) (\n    rate(\n      gitlab_ci_queue_retrieval_duration_seconds_bucket{\n        environment=\"$environment\",\n        stage=\"$stage\",\n        runner_type=~\"${runner_type:pipe}\"\n      }[$__interval]\n    )\n  )\n)\n","format":"time_series","interval":"1m","intervalFactor":3,"legendFormat":"{{ runner_type }} - p90","refId":"B"},{"expr":"histogram_quantile(\n  0.95,\n  sum by (le, runner_type) (\n    rate(\n      gitlab_ci_queue_retrieval_duration_seconds_bucket{\n        environment=\"$environment\",\n        stage=\"$stage\",\n        runner_type=~\"${runner_type:pipe}\"\n      }[$__interval]\n    )\n  )\n)\n","format":"time_series","interval":"1m","intervalFactor":3,"legendFormat":"{{ runner_type }} - p95","refId":"C"},{"expr":"histogram_quantile(\n  0.99,\n  sum by (le, runner_type) (\n    rate(\n      gitlab_ci_queue_retrieval_duration_seconds_bucket{\n        environment=\"$environment\",\n        stage=\"$stage\",\n        runner_type=~\"${runner_type:pipe}\"\n      }[$__interval]\n    )\n  )\n)\n","format":"time_series","interval":"1m","intervalFactor":3,"legendFormat":"{{ runner_type }} - p99","refId":"D"}],"thresholds":[],"timeFrom":null,"timeRegions":[],"timeShift":null,"title":"Duration of the builds queue retrieval using the big query SQL","tooltip":{"shared":true,"sort":2,"value_type":"individual"},"type":"graph","xaxis":{"buckets":null,"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"s","label":"","logBase":1,"max":null,"min":0,"show":true},{"format":"short","label":null,"logBase":1,"max":1,"min":0,"show":false}],"yaxis":{"align":false,"alignLevel":null}},{"content":"Made with â¤ï¸ and [Grafonnet](https://github.com/grafana/grafonnet-lib). [Contribute to this dashboard on GitLab.com](https://gitlab.com/gitlab-com/runbooks/blob/master/dashboards/./ci-runners/incident-database.dashboard.jsonnet)\n","datasource":null,"fieldConfig":{"defaults":{"custom":{}},"overrides":[]},"gridPos":{"h":2,"w":24,"x":0,"y":50},"id":2,"mode":"markdown","options":{"content":"Made with â¤ï¸ and [Grafonnet](https://github.com/grafana/grafonnet-lib). [Contribute to this dashboard on GitLab.com](https://gitlab.com/gitlab-com/runbooks/blob/master/dashboards/./ci-runners/incident-database.dashboard.jsonnet)\n","mode":"markdown"},"pluginVersion":"7.1.0","title":"Source","type":"text"}],"refresh":"1m","schemaVersion":26,"style":"light","tags":[],"templating":{"list":[{"current":{"selected":false,"text":"Global","value":"Global"},"hide":0,"includeAll":false,"label":null,"multi":false,"name":"PROMETHEUS_DS","options":[],"query":"prometheus","refresh":1,"regex":"/(.*-gprd|Frank|Global|gprd-.*)/","skipUrlSync":false,"type":"datasource"},{"allValue":null,"current":{"selected":false,"text":"gprd","value":"gprd"},"datasource":"$PROMETHEUS_DS","definition":"","hide":0,"includeAll":false,"label":null,"multi":false,"name":"environment","options":[],"query":"label_values(gitlab_service_ops:rate, environment)","refresh":1,"regex":"","skipUrlSync":false,"sort":1,"tagValuesQuery":"","tags":[],"tagsQuery":"","type":"query","useTags":false},{"allValue":null,"current":{"text":"main","value":"main"},"hide":0,"includeAll":false,"label":"","multi":false,"name":"stage","options":[{"text":"main","value":"main"},{"text":"cny","value":"cny"},{"text":"","value":""}],"query":"main,cny,","refresh":0,"skipUrlSync":false,"type":"custom"},{"allValue":null,"current":{"selected":false,"text":"All","value":"$__all"},"datasource":"$PROMETHEUS_DS","definition":"","hide":0,"includeAll":true,"label":null,"multi":true,"name":"shard","options":[],"query":"label_values(gitlab_runner_version_info{job=~\".*\",job!~\"omnibus-runners|gprd-runner\",shard!=\"default\"}, shard)\n","refresh":1,"regex":"","skipUrlSync":false,"sort":true,"tagValuesQuery":"","tags":[],"tagsQuery":"","type":"query","useTags":false},{"allValue":null,"current":{"selected":false,"text":"All","value":"$__all"},"datasource":"$PROMETHEUS_DS","definition":"","hide":0,"includeAll":true,"label":null,"multi":true,"name":"runner_manager","options":[],"query":"query_result(label_replace(gitlab_runner_version_info{shard=~\"$shard\"}, \"fqdn\", \"$1.*\", \"instance\", \"(.*):[0-9]+$\"))\n","refresh":1,"regex":"/fqdn=\"([^\"]+)\"/","skipUrlSync":false,"sort":true,"tagValuesQuery":"","tags":[],"tagsQuery":"","type":"query","useTags":false},{"allValue":null,"current":{"selected":true,"text":["0"],"value":["0"]},"datasource":"$PROMETHEUS_DS","definition":"","hide":0,"includeAll":true,"label":null,"multi":true,"name":"jobs_running_for_project","options":[],"query":"label_values(job_queue_duration_seconds_sum, jobs_running_for_project)\n","refresh":1,"regex":"","skipUrlSync":false,"sort":true,"tagValuesQuery":"","tags":[],"tagsQuery":"","type":"query","useTags":false},{"allValue":null,"current":{"selected":false,"text":"patroni-07-db-gprd.c.gitlab-production.internal","value":"patroni-07-db-gprd.c.gitlab-production.internal"},"datasource":"$PROMETHEUS_DS","definition":"","hide":2,"includeAll":false,"label":null,"multi":false,"name":"db_instance","options":[],"query":"query_result(pg_replication_is_replica{environment=\"$environment\"} == 0)\n","refresh":1,"regex":"/.*fqdn=\"(.*?)\".*/","skipUrlSync":false,"sort":true,"tagValuesQuery":"","tags":[],"tagsQuery":"","type":"query","useTags":false},{"allValue":null,"current":{"selected":false,"text":"All","value":"$__all"},"datasource":"$PROMETHEUS_DS","definition":"","hide":2,"includeAll":true,"label":null,"multi":true,"name":"db_instances","options":[],"query":"label_values(pg_slow_queries{environment=\"$environment\"},fqdn)\n","refresh":1,"regex":"","skipUrlSync":false,"sort":true,"tagValuesQuery":"","tags":[],"tagsQuery":"","type":"query","useTags":false},{"allValue":null,"current":{"selected":false,"text":"gitlabhq_production","value":"gitlabhq_production"},"datasource":"$PROMETHEUS_DS","definition":"","hide":2,"includeAll":false,"label":null,"multi":false,"name":"db_database","options":[],"query":"label_values(pg_stat_database_tup_deleted{env=\"$environment\",fqdn=\"$db_instance\"}, datname)\n","refresh":1,"regex":"/gitlabhq_.*/","skipUrlSync":false,"sort":true,"tagValuesQuery":"","tags":[],"tagsQuery":"","type":"query","useTags":false},{"allValue":null,"current":{"selected":false,"text":"All","value":"$__all"},"datasource":"$PROMETHEUS_DS","definition":"","hide":2,"includeAll":true,"label":null,"multi":true,"name":"db_top_dead_tup","options":[],"query":"query_result(topk(20, max_over_time(pg_stat_user_tables_n_dead_tup{env=\"$environment\",fqdn=\"$db_instance\",datname=\"$db_database\"}[${__range_s}s])))\n","refresh":1,"regex":"/.*relname=\"(.*?)\".*/","skipUrlSync":false,"sort":true,"tagValuesQuery":"","tags":[],"tagsQuery":"","type":"query","useTags":false},{"allValue":null,"current":{"selected":false,"text":"All","value":"$__all"},"datasource":"$PROMETHEUS_DS","definition":"","hide":0,"includeAll":true,"label":null,"multi":true,"name":"runner_type","options":[],"query":"label_values(gitlab_ci_queue_retrieval_duration_seconds_bucket{environment=\"$environment\"}, runner_type)\n","refresh":1,"regex":"","skipUrlSync":false,"sort":true,"tagValuesQuery":"","tags":[],"tagsQuery":"","type":"query","useTags":false}]},"time":{"from":"now-7d","to":"now"},"timepicker":{"refresh_intervals":["5s","10s","30s","1m","5m","15m","30m","1h","2h","1d"],"time_options":["5m","15m","1h","6h","12h","24h","2d","7d","30d"]},"timezone":"utc","title":"ci-runners-23","uid":"VoHXPmjMk","version":4}}