{
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": {
          "type": "grafana",
          "uid": "-- Grafana --"
        },
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "type": "dashboard"
      }
    ]
  },
  "description": "This dashboard gives an overview of the components the Pre-receive SD feature interacts and monitors their stability and performance.",
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 0,
  "id": null,
  "links": [

  ],
  "liveNow": true,
  "panels": [
    {
      "datasource": {
        "type": "prometheus",
        "uid": "PA258B30F88C30650"
      },
      "description": "",
      "gridPos": {
        "h": 3,
        "w": 24,
        "x": 0,
        "y": 0
      },
      "id": 8,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "# Pre-receive Secret Detection ‚Äì Overview\n\nPlease read the associated [runbook](https://handbook.gitlab.com/handbook/engineering/development/sec/secure/secret-detection/runbooks/pre-receive-secret-detection-monitoring/) for more information on how to read and update this dashboard.",
        "mode": "markdown"
      },
      "pluginVersion": "10.4.2",
      "type": "text"
    },
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 3
      },
      "id": 3,
      "panels": [

      ],
      "title": "üêé Workhorse",
      "type": "row"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "PA258B30F88C30650"
      },
      "description": "This panel displays the number of HTTP requests that have been processed by `workhorse` over time, increasing in range of 24 hours. The panel partitions these requests by the HTTP verb/method and response code. This panel can be used to determine if the amount of `git-receive-pack` requests with a response code that isn't `200` had increased recently, indicating an issue with processing such requests.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "drawStyle": "line",
            "fillOpacity": 0,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineInterpolation": "smooth",
            "lineStyle": {
              "fill": "solid"
            },
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "never",
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [

          ],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "none"
        },
        "overrides": [

        ]
      },
      "gridPos": {
        "h": 7,
        "w": 24,
        "x": 0,
        "y": 4
      },
      "id": 2,
      "options": {
        "legend": {
          "calcs": [

          ],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "mode": "single",
          "sort": "none"
        }
      },
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PA258B30F88C30650"
          },
          "disableTextWrap": false,
          "editorMode": "builder",
          "exemplar": false,
          "expr": "sum by(code, method) (increase(gitlab_workhorse_git_http_requests{exported_service=\"git-receive-pack\", stage=\"main\", env=\"gprd\", code!=\"0\"}[24h]))",
          "fullMetaSearch": false,
          "includeNullMetadata": false,
          "instant": false,
          "interval": "1h",
          "legendFormat": "{{code}} | {{method}}",
          "range": true,
          "refId": "A",
          "useBackend": false
        }
      ],
      "title": "Processed `git-receive-pack` Requests",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "PA258B30F88C30650"
      },
      "description": "This panel displays the total number of `Gitaly` connections that have been established by `workhorse` at a given time. This panel can be used to determine if there's a sudden drop in connections between both components, which may indicate a performance or an availability issue.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "drawStyle": "line",
            "fillOpacity": 10,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "auto",
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [

          ],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          }
        },
        "overrides": [

        ]
      },
      "gridPos": {
        "h": 7,
        "w": 24,
        "x": 0,
        "y": 11
      },
      "id": 6,
      "options": {
        "legend": {
          "calcs": [

          ],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "mode": "single",
          "sort": "none"
        }
      },
      "pluginVersion": "10.4.2",
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PA258B30F88C30650"
          },
          "disableTextWrap": false,
          "editorMode": "builder",
          "exemplar": false,
          "expr": "count by(status) (gitlab_workhorse_gitaly_connections_total{env=\"gprd\", stage=\"main\"})",
          "format": "time_series",
          "fullMetaSearch": false,
          "includeNullMetadata": true,
          "instant": false,
          "interval": "",
          "legendFormat": "{{status}}",
          "range": true,
          "refId": "A",
          "useBackend": false
        }
      ],
      "title": "Total Established Gitaly Connections",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "PA258B30F88C30650"
      },
      "description": "This panel displays the average latency (duration) in seconds for the `/.git/git-receive-pack` request for all nodes running `workhorse`. This panel can be used to determine if there is an increase in response times for that specific request, which could indicate performance degradation issue if it surpassed a certain thershold.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "drawStyle": "line",
            "fillOpacity": 10,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineInterpolation": "linear",
            "lineStyle": {
              "fill": "solid"
            },
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "auto",
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [

          ],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "s"
        },
        "overrides": [

        ]
      },
      "gridPos": {
        "h": 7,
        "w": 24,
        "x": 0,
        "y": 18
      },
      "id": 7,
      "options": {
        "legend": {
          "calcs": [

          ],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "mode": "single",
          "sort": "none"
        }
      },
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PA258B30F88C30650"
          },
          "disableTextWrap": false,
          "editorMode": "builder",
          "expr": "sum(rate(gitlab_workhorse_http_request_duration_seconds_sum{env=\"gprd\", stage=\"main\", route=\"^/.+\\\\.git/git-receive-pack\\\\z\"}[24h])) / sum(rate(gitlab_workhorse_http_request_duration_seconds_count{env=\"gprd\", stage=\"main\", route=\"^/.+\\\\.git/git-receive-pack\\\\z\"}[24h]))",
          "fullMetaSearch": false,
          "includeNullMetadata": false,
          "instant": false,
          "interval": "",
          "legendFormat": "{{label_name}}",
          "range": true,
          "refId": "A",
          "useBackend": false
        }
      ],
      "title": "Average Latency for `/.git/git-receive-pack` Request [All Nodes]",
      "type": "timeseries"
    },
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 25
      },
      "id": 4,
      "panels": [

      ],
      "title": "‚öôÔ∏è Gitaly",
      "type": "row"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "PA5EEDCB71676F488"
      },
      "description": "",
      "gridPos": {
        "h": 7,
        "w": 6,
        "x": 0,
        "y": 26
      },
      "id": 12,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "#### During `/internal/allowed` Endpoint ‚Äì Loading Blobs\n\n\nTODO: Explain how these RPCs are while checking secrets from the `/internal/allowed` endpoint to load blobs of a certain `git` push operation.",
        "mode": "markdown"
      },
      "pluginVersion": "10.4.2",
      "type": "text"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "PA5EEDCB71676F488"
      },
      "description": "This panel displays the average latency in milliseconds for all calls to the `ListAllBlobs` RPC, which is responsible (within the context of the feature) for enumerating all blobs of a repository under a certain size limit (i.e. exactly 1MiB). This procedure is usually fast because it is mostly used with the size limit set to `0` for checking file sizes of blobs in a certain `git` push.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "decimals": 0,
          "mappings": [
            {
              "options": {
                "null": {
                  "index": 0,
                  "text": "N/A"
                }
              },
              "type": "value"
            }
          ],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "ms"
        },
        "overrides": [

        ]
      },
      "gridPos": {
        "h": 7,
        "w": 9,
        "x": 6,
        "y": 26
      },
      "id": 10,
      "links": [
        {
          "targetBlank": true,
          "title": "ListAllBlobs ‚Äì Latency Detail",
          "url": "https://dashboards.gitlab.net/d/PqeIQ9Iik/gitaly-feature-latency-detail?from=now-24h&orgId=1&refresh=5m&to=now&var-job=gitaly&var-method=ListAllBlobs"
        }
      ],
      "options": {
        "colorMode": "background",
        "graphMode": "area",
        "justifyMode": "auto",
        "orientation": "horizontal",
        "reduceOptions": {
          "calcs": [
            "mean"
          ],
          "fields": "/^Value$/",
          "values": false
        },
        "showPercentChange": false,
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "10.4.2",
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PA5EEDCB71676F488"
          },
          "dsType": "influxdb",
          "editorMode": "code",
          "exemplar": false,
          "expr": "avg(1000 * avg(gitaly:grpc_server_handling_seconds:avg5m{job=\"gitaly\", grpc_method=\"ListAllBlobs\"}))\n",
          "format": "time_series",
          "groupBy": [
            {
              "params": [
                "$__interval"
              ],
              "type": "time"
            },
            {
              "params": [
                "null"
              ],
              "type": "fill"
            }
          ],
          "instant": false,
          "interval": "",
          "intervalFactor": 2,
          "legendFormat": "{{ method }}",
          "orderByTime": "ASC",
          "policy": "default",
          "range": true,
          "refId": "A",
          "resultFormat": "time_series",
          "select": [
            [
              {
                "params": [
                  "value"
                ],
                "type": "field"
              },
              {
                "params": [

                ],
                "type": "mean"
              }
            ]
          ],
          "step": 3600,
          "tags": [

          ]
        }
      ],
      "title": "ListAllBlobs ‚Äì Average Latency [All Hosts]",
      "type": "stat"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "PA5EEDCB71676F488"
      },
      "description": "This panel displays the average latency in milliseconds for all calls to the `ListBlobs` RPC, which is responsible (within the context of the feature) for enumerating all blobs of a repository under a certain size limit (i.e. exactly 1MiB), similar to `ListAllBlobs`, but it also loads up file paths for those blobs. The procedure is often slower than `ListAllBlobs` because it loads up blob contents when enumerating them. ",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "decimals": 0,
          "mappings": [
            {
              "options": {
                "null": {
                  "index": 0,
                  "text": "N/A"
                }
              },
              "type": "value"
            }
          ],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "ms"
        },
        "overrides": [

        ]
      },
      "gridPos": {
        "h": 7,
        "w": 9,
        "x": 15,
        "y": 26
      },
      "id": 11,
      "links": [
        {
          "targetBlank": true,
          "title": "ListBlobs ‚Äì Latency Detail",
          "url": "https://dashboards.gitlab.net/d/PqeIQ9Iik/gitaly-feature-latency-detail?from=now-24h&orgId=1&refresh=5m&to=now&var-job=gitaly&var-method=ListBlobs"
        }
      ],
      "options": {
        "colorMode": "background",
        "graphMode": "area",
        "justifyMode": "auto",
        "orientation": "horizontal",
        "reduceOptions": {
          "calcs": [
            "mean"
          ],
          "fields": "/^Value$/",
          "values": false
        },
        "showPercentChange": false,
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "10.4.2",
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PA5EEDCB71676F488"
          },
          "dsType": "influxdb",
          "editorMode": "code",
          "exemplar": false,
          "expr": "avg(1000 * avg(gitaly:grpc_server_handling_seconds:avg5m{job=\"gitaly\", grpc_method=\"ListBlobs\"}))\n",
          "format": "time_series",
          "groupBy": [
            {
              "params": [
                "$__interval"
              ],
              "type": "time"
            },
            {
              "params": [
                "null"
              ],
              "type": "fill"
            }
          ],
          "instant": false,
          "interval": "",
          "intervalFactor": 2,
          "legendFormat": "{{ method }}",
          "orderByTime": "ASC",
          "policy": "default",
          "range": true,
          "refId": "A",
          "resultFormat": "time_series",
          "select": [
            [
              {
                "params": [
                  "value"
                ],
                "type": "field"
              },
              {
                "params": [

                ],
                "type": "mean"
              }
            ]
          ],
          "step": 3600,
          "tags": [

          ]
        }
      ],
      "title": "ListBlobs ‚Äì Average Latency [All Hosts]",
      "type": "stat"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "PA5EEDCB71676F488"
      },
      "description": "",
      "gridPos": {
        "h": 7,
        "w": 7,
        "x": 0,
        "y": 33
      },
      "id": 13,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "#### During `/internal/allowed` Endpoint ‚Äì Retrieving Blob Metadata\n\nTODO: Explain how this RPC is used while checking secrets from the `/internal/allowed` endpoint to retrieve blob metadata for blobs received in a certain `git` push operation.",
        "mode": "markdown"
      },
      "pluginVersion": "10.4.2",
      "type": "text"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "PA5EEDCB71676F488"
      },
      "description": "This panel displays the average latency in milliseconds for all calls to the GetTreeEntries RPC, which is responsible (within the context of the feature) for retrieving blob metadata (i.e. file path and commit sha) for all blobs that were scanned and found to include a leaked secret.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "decimals": 0,
          "mappings": [

          ],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "ms"
        },
        "overrides": [

        ]
      },
      "gridPos": {
        "h": 7,
        "w": 17,
        "x": 7,
        "y": 33
      },
      "id": 9,
      "links": [
        {
          "targetBlank": true,
          "title": "GetTreeEntries ‚Äì Latency Detail",
          "url": "https://dashboards.gitlab.net/d/PqeIQ9Iik/gitaly-feature-latency-detail?from=now-24h&orgId=1&refresh=5m&to=now&var-job=gitaly&var-method=GetTreeEntries"
        }
      ],
      "options": {
        "colorMode": "background",
        "graphMode": "area",
        "justifyMode": "auto",
        "orientation": "horizontal",
        "reduceOptions": {
          "calcs": [
            "mean"
          ],
          "fields": "/^Value$/",
          "values": false
        },
        "showPercentChange": false,
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "10.4.2",
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PA5EEDCB71676F488"
          },
          "dsType": "influxdb",
          "editorMode": "code",
          "exemplar": false,
          "expr": "avg(1000 * avg(gitaly:grpc_server_handling_seconds:avg5m{job=\"gitaly\", grpc_method=\"GetTreeEntries\"}))\n",
          "format": "time_series",
          "groupBy": [
            {
              "params": [
                "$__interval"
              ],
              "type": "time"
            },
            {
              "params": [
                "null"
              ],
              "type": "fill"
            }
          ],
          "instant": false,
          "interval": "",
          "intervalFactor": 2,
          "legendFormat": "{{ method }}",
          "orderByTime": "ASC",
          "policy": "default",
          "range": true,
          "refId": "A",
          "resultFormat": "time_series",
          "select": [
            [
              {
                "params": [
                  "value"
                ],
                "type": "field"
              },
              {
                "params": [

                ],
                "type": "mean"
              }
            ]
          ],
          "step": 3600,
          "tags": [

          ]
        }
      ],
      "title": "GetTreeEntries ‚Äì Average Latency",
      "type": "stat"
    },
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 40
      },
      "id": 5,
      "panels": [

      ],
      "title": "üöÇ Rails",
      "type": "row"
    }
  ],
  "schemaVersion": 39,
  "tags": [
    "secret-detection",
    "pre-receive-secret-detection",
    "secure",
    "gitaly",
    "rails",
    "workhorse",
    "unmanaged"
  ],
  "templating": {
    "list": [

    ]
  },
  "time": {
    "from": "now-24h",
    "to": "now"
  },
  "timepicker": {
  },
  "timezone": "",
  "title": "Pre-receive Secret Detection ‚Äì Overview",
  "uid": "fdk7i56zibv28d",
  "version": 31,
  "weekStart": ""
}